<!DOCTYPE html>
<html lang="en">
<head>
    <meat charset="utf-8"></meat>
    <title>Croc pit</title>
    <style>
        body {
            display: flex;
            align-items: center;
            flex-direction: column;
        }
        canvas {
            height: 600px;
            width: 700px;
        }
        #rightarrow, #leftarrow, #downarrow, #uparrow {
            border: 1px solid #aba8a8;
            padding: 5px 10px;
            margin-right: 5px;
            margin-top: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<script src="/socket.io/socket.io.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    const socket = io('/game');
    let  width = 0, height = 0, player_width = 0, player_height, canvas, ctx, ball
    let message = ""
    let username = []
    let space_down = false

    $('body').on('keydown', (e) => {
        socket.emit('keydown', e.keyCode)
        console.log(e.keyCode)
        if (e.keyCode === 32) {
            let space = 0
            if (space_down === false) {
                space = 1;
                space_down = true;
            }
            else space = 0
            socket.emit('space_event', space)
        }
    });

    $('body').on('keyup', (e) => {
        socket.emit('keyup', e.keyCode);
        if (e.keyCode == 32)
            space_down = false
    });

    let players = [];
    class player {
        constructor (xpos = 0, ypos = 0) {
            this.x = xpos;
            this.y = ypos;
            this.width = 0
            this.height = 0;
            this.username = "";
        }

        update() {
            this.width = player_width;
            this.height = player_height;
        }

        draw() {
            const img = new Image();
            img.src = 'https://i.pinimg.com/originals/eb/e7/9e/ebe79e9400e4ca611772cd324bb2a93f.png';
            ctx.drawImage(img, this.x, this.y, this.width, this.height);
        }
    };

    ball = {
        x: null,
        y: null,
        vel: null,
        side: 0,
        speed: 8,

        draw: function() {
            ctx.fillRect(this.x, this.y, this.side, this.side);
        }
    };

    function init() {
        console.log(player_width);
    }

    function update() {
        for (p in players) {
            players[p].update();
        }
    }

    function draw() {
        ctx.fillRect(0, 0, width, height);
        ctx.save();
        ctx.fillStyle = "#fff"

        for (p in players) {
            players[p].draw();
        }

        ball.draw();
        ctx.restore();
    }

    function main() {
        canvas = document.createElement("canvas")
        ctx = canvas.getContext("2d")
        document.body.appendChild(canvas)

        let divHTML = '<div style="display: flex; flex-direction: column; align-items: center; height: 200px">' +
                          '<div id="uparrow">&#11014;</div>' +
                          '<div style="display: flex; flex-direction: row"><div id="leftarrow">&#11013;</div><div id="rightarrow">&#11157;</div></div>' +
                          '<div id="downarrow">&#11015;</div>' +
                      '</div>'
        canvas.insertAdjacentHTML('afterend', divHTML)

        const uparrow    = document.getElementById('uparrow')
        const leftarrow  = document.getElementById('uparrow')
        const rightarrow = document.getElementById('uparrow')
        const downarrow  = document.getElementById('uparrow')

        uparrow.addEventListener("mouseenter", function() {
            socket.emit('key_control_event', 'UP')
        })
        uparrow.addEventListener("mouseleave", function() {
            socket.emit('key_release_control_event', 'UP')
        })

        var loop = function() {
            canvas.width = width;
            canvas.height = height;
            update();
            draw();
            window.requestAnimationFrame(loop, canvas);
        }
        window.requestAnimationFrame(loop, canvas);
    }


    main();

    socket.on('config', (config) => {
        width         = config.screen_width;
        height        = config.screen_height;
        player_width  = config.player_width;
        player_height = config.player_height;
        end_point     = config.end_point;
        init();
    })

    socket.on('usernames', (usernames) => {
        username.push(usernames[0]);
        username.push(usernames[1]);
    })

    socket.on('game_over', (msg) => {
        message = msg;
        let leave_button = document.createElement("button")
        leave_button.innerHTML = "Go Back To Menu"
        let body = document.getElementsByTagName("body")[0]
        body.appendChild(leave_button)
        leave_button.addEventListener("click", function () {
            window.location.href = '/'
        })
    })

    // update game info
    socket.on('update', (ids, player_status, ball_status) => {
        players = []
        for (id of ids) {
            if (players[id] == null || players[id] === undefined)
                players[id] = new player(player_status[id].x, player_status[id].y)
            else {
                players[id].x = player_status[id].x;
                players[id].y = player_status[id].y;
            }
        }
    });

</script>
</body>
</html>
